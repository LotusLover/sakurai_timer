<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>桜井タイマー</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP"; padding: 16px; }
    #stage { position: relative; width: 640px; }
    video, canvas { width: 100%; height: auto; border-radius: 6px; background: #000; }
    #controls { margin-top: 8px; display:flex; gap:8px; }
    button:disabled { opacity: 0.5; }
    #status { margin-top:8px; font-weight:600; }
  </style>
</head>
<body>
  <h2>桜井タイマー</h2>
  <div id="stage">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="overlay"></canvas>
  </div>

  <div id="controls">
    <button id="startBtn">Start 5:00</button>
    <button id="pauseBtn" disabled>Pause</button>
    <button id="stopBtn" disabled>Stop (requires face)</button>
  </div>

  <div id="status">状態: 初期化中…</div>

<script type="module">
import FaceDetection from 'https://cdn.jsdelivr.net/npm/@mediapipe/face_detection@0.4.1646425229/face_detection.js';
import { drawConnectors, drawLandmarks } from 'https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.4.1646425229/drawing_utils.js';

const video = document.getElementById('video');
const canvas = document.getElementById('overlay');
const ctx = canvas.getContext('2d');
const statusEl = document.getElementById('status');
const startBtn = document.getElementById('startBtn');
const pauseBtn = document.getElementById('pauseBtn');
const stopBtn = document.getElementById('stopBtn');

let timerSeconds = 5 * 60; // 初期 5分
let timerId = null;
let running = false;
let facePresent = false;
let facePresentSince = 0; // 連続検出開始のタイムスタンプ

// 描画サイズ合わせ
function resizeCanvas() {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
}
video.addEventListener('loadedmetadata', resizeCanvas);

// MediaPipe FaceDetection セットアップ
const faceDetection = new FaceDetection({
  locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection@0.4.1646425229/${file}`
});

faceDetection.setOptions({
  model: 'short',         // 'short' or 'full'（軽量/精度トレードオフ）
  minDetectionConfidence: 0.6
});

faceDetection.onResults(onResults);

// カメラ取得
async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }});
    video.srcObject = stream;
    await video.play();
    // MediaPipe へフレーム送信ループ
    async function frameLoop() {
      if (video.readyState >= 2) {
        await faceDetection.send({image: video});
      }
      requestAnimationFrame(frameLoop);
    }
    frameLoop();
    statusEl.textContent = '状態: カメラ動作中。顔を検出待ち...';
  } catch (e) {
    statusEl.textContent = 'エラー: カメラにアクセスできません。HTTPSで開いているか確認してください。';
    console.error(e);
  }
}

// FaceDetection 結果処理
function onResults(results) {
  // 描画クリア
  ctx.clearRect(0,0,canvas.width, canvas.height);

  const now = performance.now();
  if (results.detections && results.detections.length > 0) {
    facePresent = true;
    if (!facePresentSince) facePresentSince = now;
    // 簡易的にバウンディングボックスを描画
    for (const det of results.detections) {
      const box = det.boundingBox;
      const x = box.xCenter - box.width/2;
      const y = box.yCenter - box.height/2;
      ctx.strokeStyle = 'lime';
      ctx.lineWidth = 3;
      ctx.strokeRect(x * canvas.width, y * canvas.height, box.width * canvas.width, box.height * canvas.height);
      // ランドマークがあれば描画（MediaPipeのデータ構造による）
      if (det.keypoints) {
        for (const kp of det.keypoints) {
          ctx.fillStyle = 'yellow';
          ctx.beginPath();
          ctx.arc(kp.x * canvas.width, kp.y * canvas.height, 3, 0, Math.PI*2);
          ctx.fill();
        }
      }
    }
  } else {
    facePresent = false;
    facePresentSince = 0;
  }

  // UI更新
  statusEl.textContent = `状態: ${facePresent ? '顔検出中' : '顔なし'} | タイマー: ${formatTime(timerSeconds)}`;
  // Stop許可条件：顔が直近で検出されている（ここでは0.5秒以上連続検出を要件に）
  const enoughContinuous = facePresent && (performance.now() - facePresentSince) > 500;
  stopBtn.disabled = !enoughContinuous;
  pauseBtn.disabled = !running;
}

// タイマー表示フォーマット
function formatTime(s) {
  const mm = String(Math.floor(s/60)).padStart(2,'0');
  const ss = String(s % 60).padStart(2,'0');
  return `${mm}:${ss}`;
}

// タイマー操作
function startTimer() {
  if (running) return;
  running = true;
  pauseBtn.disabled = false;
  startBtn.disabled = true;
  timerId = setInterval(() => {
    if (timerSeconds <= 0) {
      clearInterval(timerId);
      running = false;
      statusEl.textContent = '完了！';
      return;
    }
    timerSeconds--;
  }, 1000);
}

function pauseTimer() {
  if (!running) return;
  clearInterval(timerId);
  running = false;
  startBtn.disabled = false;
  pauseBtn.disabled = true;
}

function stopTimer() {
  // 停止処理は onResults の条件で stopBtn が有効なときのみ呼ばれる
  clearInterval(timerId);
  running = false;
  timerSeconds = 5 * 60; // リセット（必要に応じ変更）
  startBtn.disabled = false;
  pauseBtn.disabled = true;
  stopBtn.disabled = true;
  statusEl.textContent = '停止しました（リセット）。';
}

// UI イベント
startBtn.addEventListener('click', () => {
  startTimer();
});
pauseBtn.addEventListener('click', () => {
  pauseTimer();
});
stopBtn.addEventListener('click', () => {
  // 二重チェック：直近で顔が検出されていることを再確認
  if (!facePresent || (performance.now() - facePresentSince) < 500) {
    alert('顔が検出されていないため停止できません。顔をカメラに写してください。');
    return;
  }
  stopTimer();
});

// 初期化
startCamera();
</script>
</body>
</html>
