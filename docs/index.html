<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>æ¡œäº•ã‚¿ã‚¤ãƒãƒ¼</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: 'Segoe UI', 'Noto Sans JP', system-ui, -apple-system; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 30px;
      max-width: 700px;
      width: 100%;
    }
    
    h1 {
      text-align: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 32px;
      margin-bottom: 8px;
      letter-spacing: 1px;
    }
    
    .subtitle {
      text-align: center;
      color: #999;
      font-size: 14px;
      margin-bottom: 24px;
    }

    #timeSettings {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 24px;
    }

    #timeSettings h4 {
      color: #333;
      margin-bottom: 12px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .preset-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .preset-btn {
      padding: 8px 14px;
      font-size: 12px;
      font-weight: 600;
      border: 2px solid #667eea;
      background: white;
      color: #667eea;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .preset-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .preset-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: transparent;
    }

    .custom-time {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .custom-time label {
      font-size: 12px;
      font-weight: 600;
      color: #555;
    }

    .custom-time input {
      width: 70px;
      padding: 8px 12px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      transition: border-color 0.3s ease;
    }

    .custom-time input:focus {
      outline: none;
      border-color: #667eea;
    }

    #setCustomBtn {
      padding: 8px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    #setCustomBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .timer-display {
      text-align: center;
      font-size: 48px;
      font-weight: 900;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-top: 12px;
      letter-spacing: 2px;
      font-family: 'Courier New', monospace;
    }

    #stage {
      position: relative;
      width: 100%;
      aspect-ratio: 4 / 3;
      border-radius: 15px;
      overflow: hidden;
      margin-bottom: 24px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      background: #000;
    }

    video, canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    #controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 20px;
      justify-content: center;
    }

    #controls button {
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
      min-width: 120px;
    }

    #startBtn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    #pauseBtn {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }

    #stopBtn {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      color: white;
    }

    #resetBtn {
      background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
      color: white;
    }

    #controls button:hover:not(:disabled) {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }

    #controls button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #status {
      background: #f0f4f8;
      padding: 16px;
      border-radius: 10px;
      text-align: center;
      font-weight: 600;
      color: #333;
      font-size: 14px;
      border-left: 4px solid #667eea;
    }

    #devicePanel {
      margin-top: 16px;
      padding: 12px;
      background: rgba(102, 126, 234, 0.1);
      border-radius: 8px;
      border: 2px solid #667eea;
    }

    #deviceSelect {
      padding: 6px 10px;
      border: 1px solid #667eea;
      border-radius: 4px;
      font-size: 12px;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    #deviceSelect:hover {
      border-color: #764ba2;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }

    #deviceSelect:focus {
      outline: none;
      border-color: #764ba2;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    @media (max-width: 600px) {
      .container {
        padding: 20px;
      }

      h1 {
        font-size: 24px;
      }

      .timer-display {
        font-size: 36px;
      }

      #controls {
        flex-direction: column;
      }

      #controls button {
        width: 100%;
        min-width: unset;
      }

      .preset-buttons {
        gap: 6px;
      }

      .preset-btn {
        padding: 6px 10px;
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>â±ï¸ æ¡œäº•ã‚¿ã‚¤ãƒãƒ¼</h1>
    <p class="subtitle">é›†ä¸­åŠ›ã‚’é«˜ã‚ã‚‹é¡”èªè­˜ã‚¿ã‚¤ãƒãƒ¼</p>
    
    <div id="timeSettings">
      <h4>â° ã‚¿ã‚¤ãƒãƒ¼è¨­å®š</h4>
      <div class="preset-buttons">
        <button class="preset-btn" data-seconds="60">1åˆ†</button>
        <button class="preset-btn" data-seconds="180">3åˆ†</button>
        <button class="preset-btn active" data-seconds="300">5åˆ†</button>
        <button class="preset-btn" data-seconds="600">10åˆ†</button>
        <button class="preset-btn" data-seconds="900">15åˆ†</button>
        <button class="preset-btn" data-seconds="1500">25åˆ†</button>
        <button class="preset-btn" data-seconds="1800">30åˆ†</button>
        <button class="preset-btn" data-seconds="3600">60åˆ†</button>
      </div>
      <div class="custom-time">
        <label>ã‚«ã‚¹ã‚¿ãƒ :</label>
        <input type="number" id="customMinutes" min="1" max="999" placeholder="åˆ†">
        <label>åˆ†</label>
        <input type="number" id="customSeconds" min="0" max="59" placeholder="ç§’">
        <label>ç§’</label>
        <button id="setCustomBtn">è¨­å®š</button>
      </div>
      <div class="timer-display" id="timerDisplay">05:00</div>
      
      <!-- ãƒ‡ãƒã‚¤ã‚¹é¸æŠãƒ‘ãƒãƒ«ï¼ˆåŸ‹ã‚è¾¼ã¿ï¼‰ -->
      <div id="devicePanel" style="margin-top: 16px; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; border: 2px solid #667eea;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
          <label style="font-size: 12px; font-weight: 600; color: #555; flex-shrink: 0;">ğŸ”Š éŸ³å£°å‡ºåŠ›:</label>
          <select id="deviceSelect" style="flex: 1; padding: 6px 10px; border: 1px solid #667eea; border-radius: 4px; font-size: 12px;">
            <option>ãƒ‡ãƒã‚¤ã‚¹ã‚’èª­ã¿è¾¼ã¿ä¸­...</option>
          </select>
        </div>
      </div>
    </div>
       <!-- å‹•ç”»è¡¨ç¤ºç”¨ãƒ‘ãƒãƒ«ï¼ˆåŸ‹ã‚è¾¼ã¿ï¼‰ -->
    <div id="videoPanel" style="display:none; margin-bottom: 24px; border-radius: 15px; overflow: hidden; box-shadow: 0 8px 24px rgba(0,0,0,0.15); background: #000; position: relative;">
      <video id="videoPlayer" style="width:100%; height:auto; display:block;" loop></video>
      <button id="videoCloseBtn" style="position:absolute; top:10px; right:10px; width:40px; height:40px; border:none; border-radius:50%; background:#ff6b6b; color:white; font-size:20px; cursor:pointer; z-index:10; opacity:0.8;">âœ•</button>
    </div>

 <div id="controls">
      <button id="startBtn">â–¶ï¸ Start</button>
      <button id="pauseBtn" disabled>â¸ï¸ Pause</button>
      <button id="stopBtn" disabled>â¹ï¸ Stop</button>
      <button id="resetBtn">ğŸ”„ Reset</button>
    </div>

    <div id="stage">
      <video id="video" autoplay muted playsinline></video>
      <canvas id="overlay"></canvas>
    </div>

 
   
    <div id="status">çŠ¶æ…‹: åˆæœŸåŒ–ä¸­â€¦</div>
  </div>

  <!-- éŸ³å£°/å‹•ç”»å†ç”Ÿç”¨ -->
  <audio id="completeSound" preload="auto" loop></audio>
  <video id="completeVideo" preload="auto" loop style="display:none;"></video>

  <!-- ãƒ‡ãƒã‚¤ã‚¹é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
  <div id="deviceModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; display:none; justify-content:center; align-items:center;">
    <div style="background:white; border-radius:15px; padding:30px; max-width:400px; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
      <h3 style="margin-bottom:16px; color:#333;">ğŸ”Š éŸ³å£°å‡ºåŠ›ãƒ‡ãƒã‚¤ã‚¹ã‚’é¸æŠ</h3>
      <select id="deviceSelect" style="width:100%; padding:10px; border:2px solid #667eea; border-radius:6px; font-size:14px; margin-bottom:16px;">
        <option>ãƒ‡ãƒã‚¤ã‚¹ã‚’èª­ã¿è¾¼ã¿ä¸­...</option>
      </select>
      <div style="display:flex; gap:10px; justify-content:flex-end;">
        <button id="deviceCloseBtn" style="padding:8px 16px; background:#ccc; border:none; border-radius:6px; cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="deviceConfirmBtn" style="padding:8px 16px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; border-radius:6px; cursor:pointer;">æ±ºå®š</button>
      </div>
    </div>
  </div>

<!-- MediaPipeã‚’ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã§èª­ã¿è¾¼ã¿ -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/face_detection.js" crossorigin="anonymous"></script>
<script>
const video = document.getElementById('video');
const canvas = document.getElementById('overlay');
const ctx = canvas.getContext('2d');
const statusEl = document.getElementById('status');
const startBtn = document.getElementById('startBtn');
const pauseBtn = document.getElementById('pauseBtn');
const stopBtn = document.getElementById('stopBtn');
const resetBtn = document.getElementById('resetBtn');
const timerDisplay = document.getElementById('timerDisplay');
const customMinutes = document.getElementById('customMinutes');
const customSeconds = document.getElementById('customSeconds');
const setCustomBtn = document.getElementById('setCustomBtn');
const completeSound = document.getElementById('completeSound');
const completeVideo = document.getElementById('completeVideo');
const videoPanel = document.getElementById('videoPanel');
const videoPlayer = document.getElementById('videoPlayer');
const videoCloseBtn = document.getElementById('videoCloseBtn');

// ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’è¨­å®šï¼ˆMP3ã¾ãŸã¯MP4ï¼‰
// ä¾‹: './complete.mp3' ã¾ãŸã¯ './celebration.mp4'
const mediaFile = './complete.mp4';
let isVideo = mediaFile.endsWith('.mp4');
let mediaFileAudio = './complete.mp3'; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«

if (isVideo) {
  completeVideo.src = mediaFile;
  videoPlayer.src = mediaFile;
} else {
  completeSound.src = mediaFile;
}

// MP4ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
if (isVideo) {
  videoPlayer.addEventListener('error', () => {
    console.warn('å‹•ç”»ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸã€‚éŸ³å£°ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚');
    isVideo = false; // å‹•ç”»ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤
    
    // å‹•ç”»ãƒ‘ãƒãƒ«ã‚’éè¡¨ç¤º
    videoPanel.style.display = 'none';
    
    // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚»ãƒƒãƒˆ
    completeSound.src = mediaFileAudio;
    completeSound.currentTime = 0;
    completeSound.play().catch(err => {
      console.warn('éŸ³å£°å†ç”Ÿã«ã‚‚å¤±æ•—ã—ã¾ã—ãŸ:', err);
    });
  }, { once: true });
}

let initialSeconds = 5 * 60;
let timerSeconds = initialSeconds;
let timerId = null;
let running = false;
let facePresent = false;
let facePresentSince = 0;
let isCompleteSound = false; // å®Œäº†éŸ³ãŒé³´ã£ã¦ã„ã‚‹ã‹

// ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±å–å¾—
async function loadAudioDevices() {
  try {
    const devices = await navigator.mediaDevices.enumerateDevices();
    const audioOutputDevices = devices.filter(device => device.kind === 'audiooutput');
    
    deviceSelect.innerHTML = '';
    audioOutputDevices.forEach((device, index) => {
      const option = document.createElement('option');
      option.value = device.deviceId;
      option.textContent = device.label || `ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ ${index + 1}`;
      deviceSelect.appendChild(option);
    });
    
    if (audioOutputDevices.length === 0) {
      deviceSelect.innerHTML = '<option>åˆ©ç”¨å¯èƒ½ãªãƒ‡ãƒã‚¤ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“</option>';
    }
  } catch (err) {
    console.error('ãƒ‡ãƒã‚¤ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
    deviceSelect.innerHTML = '<option>ãƒ‡ãƒã‚¤ã‚¹å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</option>';
  }
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ‡ãƒã‚¤ã‚¹ã‚’åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', () => {
  loadAudioDevices();
});

function updateTimerDisplay() {
  timerDisplay.textContent = formatTime(timerSeconds);
}

function resizeCanvas() {
  if (!canvas) return;
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
}
video.addEventListener('loadedmetadata', resizeCanvas);

const faceDetection = new FaceDetection({
  locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${file}`
});

faceDetection.setOptions({
  model: 'short',
  minDetectionConfidence: 0.6
});

faceDetection.onResults(onResults);

document.querySelectorAll('.preset-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    if (running) return;
    
    document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    const seconds = parseInt(btn.dataset.seconds);
    initialSeconds = seconds;
    timerSeconds = seconds;
    updateTimerDisplay();
  });
});

setCustomBtn.addEventListener('click', () => {
  if (running) return;
  
  const minutes = parseInt(customMinutes.value) || 0;
  const seconds = parseInt(customSeconds.value) || 0;
  const totalSeconds = minutes * 60 + seconds;
  
  if (totalSeconds <= 0) {
    alert('1ç§’ä»¥ä¸Šã®æ™‚é–“ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
    return;
  }
  
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
  
  initialSeconds = totalSeconds;
  timerSeconds = totalSeconds;
  updateTimerDisplay();
  
  customMinutes.value = '';
  customSeconds.value = '';
});

async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        facingMode: 'user',
        width: { ideal: 1280 },
        height: { ideal: 720 }
      },
      audio: false
    });
    video.srcObject = stream;
    
    // ã‚¹ãƒãƒ›å¯¾å¿œï¼šå†ç”Ÿé–‹å§‹ã‚’æ˜ç¤ºçš„ã«å®Ÿè¡Œ
    const playPromise = video.play();
    if (playPromise !== undefined) {
      playPromise.catch(error => {
        console.warn('ãƒ“ãƒ‡ã‚ªå†ç”Ÿã‚¨ãƒ©ãƒ¼:', error);
      });
    }
    
    async function frameLoop() {
      if (video.readyState >= 2) {
        await faceDetection.send({image: video});
      }
      requestAnimationFrame(frameLoop);
    }
    frameLoop();
    statusEl.textContent = 'ğŸ“¹ ã‚«ãƒ¡ãƒ©å‹•ä½œä¸­ã€‚é¡”ã‚’æ¤œå‡ºå¾…ã¡...';
  } catch (e) {
    statusEl.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
    console.error(e);
  }
}

function onResults(results) {
  if (!canvas || !ctx) return;
  ctx.clearRect(0,0,canvas.width, canvas.height);

  const now = performance.now();
  if (results.detections && results.detections.length > 0) {
    facePresent = true;
    if (!facePresentSince) facePresentSince = now;
    for (const det of results.detections) {
      const box = det.boundingBox;
      const x = box.xCenter - box.width/2;
      const y = box.yCenter - box.height/2;
      ctx.strokeStyle = '#00ff00';
      ctx.lineWidth = 4;
      ctx.shadowColor = 'rgba(0,255,0,0.5)';
      ctx.shadowBlur = 10;
      ctx.strokeRect(x * canvas.width, y * canvas.height, box.width * canvas.width, box.height * canvas.height);
      ctx.shadowColor = 'transparent';
      if (det.keypoints) {
        for (const kp of det.keypoints) {
          ctx.fillStyle = '#ffff00';
          ctx.beginPath();
          ctx.arc(kp.x * canvas.width, kp.y * canvas.height, 4, 0, Math.PI*2);
          ctx.fill();
        }
      }
    }
  } else {
    facePresent = false;
    facePresentSince = 0;
  }

  statusEl.textContent = `${facePresent ? 'âœ… é¡”æ¤œå‡ºä¸­' : 'â­• é¡”ãªã—'} | ${running ? 'â±ï¸ ã‚¿ã‚¤ãƒãƒ¼å®Ÿè¡Œä¸­' : 'ğŸ”” ã‚¿ã‚¤ãƒãƒ¼åœæ­¢ä¸­'}${isCompleteSound ? (isVideo ? ' ğŸ¬ å‹•ç”»å†ç”Ÿä¸­' : ' ğŸ”Š éŸ³å£°å†ç”Ÿä¸­') : ''}`;
  const enoughContinuous = facePresent && (performance.now() - facePresentSince) > 500;
  stopBtn.disabled = !enoughContinuous || !running;
}

function formatTime(s) {
  const mm = String(Math.floor(s/60)).padStart(2,'0');
  const ss = String(s % 60).padStart(2,'0');
  return `${mm}:${ss}`;
}

function startTimer() {
  if (running) return;
  running = true;
  pauseBtn.disabled = false;
  startBtn.disabled = true;
  timerId = setInterval(() => {
    if (timerSeconds <= 0) {
      clearInterval(timerId);
      running = false;
      startBtn.disabled = false;
      pauseBtn.disabled = true;
      statusEl.textContent = 'ğŸ‰ å®Œäº†ï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼';
      
      // ãƒ¡ãƒ‡ã‚£ã‚¢å†ç”Ÿï¼ˆMP3ã¾ãŸã¯MP4ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯¾å¿œï¼‰
      isCompleteSound = true;
      if (isVideo) {
        // å‹•ç”»å†ç”Ÿã‚’è©¦ã¿ã‚‹
        videoPanel.style.display = 'block';
        videoPlayer.currentTime = 0;
        
        const playPromise = videoPlayer.play();
        if (playPromise !== undefined) {
          playPromise.catch(err => {
            console.warn('å‹•ç”»å†ç”Ÿã‚¨ãƒ©ãƒ¼:', err);
            // å‹•ç”»å†ç”Ÿå¤±æ•—æ™‚ã¯éŸ³å£°ã«åˆ‡ã‚Šæ›¿ãˆ
            isVideo = false;
            videoPanel.style.display = 'none';
            completeSound.src = mediaFileAudio;
            completeSound.currentTime = 0;
            completeSound.play().catch(err => {
              console.warn('éŸ³å£°å†ç”Ÿã«ã‚‚å¤±æ•—ã—ã¾ã—ãŸ:', err);
            });
          });
        }
      } else {
        // éŸ³å£°å†ç”Ÿ
        completeSound.currentTime = 0;
        completeSound.play().catch(err => {
          console.warn('éŸ³å£°å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
        });
      }
      
      if (Notification.permission === 'granted') {
        new Notification('æ¡œäº•ã‚¿ã‚¤ãƒãƒ¼', { body: 'ã‚¿ã‚¤ãƒãƒ¼ãŒå®Œäº†ã—ã¾ã—ãŸï¼' });
      }
      return;
    }
    timerSeconds--;
    updateTimerDisplay();
  }, 1000);
}

function pauseTimer() {
  if (!running) return;
  clearInterval(timerId);
  running = false;
  startBtn.disabled = false;
  pauseBtn.disabled = true;
}

function stopTimer() {
  clearInterval(timerId);
  running = false;
  timerSeconds = initialSeconds;
  startBtn.disabled = false;
  pauseBtn.disabled = true;
  stopBtn.disabled = true;
  updateTimerDisplay();
  statusEl.textContent = 'ğŸ›‘ åœæ­¢ã—ã¾ã—ãŸï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰ã€‚';
  
  // ãƒ¡ãƒ‡ã‚£ã‚¢åœæ­¢
  if (isCompleteSound) {
    if (isVideo) {
      videoPlayer.pause();
      videoPlayer.currentTime = 0;
      videoPanel.style.display = 'none';
    } else {
      completeSound.pause();
      completeSound.currentTime = 0;
    }
    isCompleteSound = false;
  }
}

function resetTimer() {
  if (running) {
    clearInterval(timerId);
    running = false;
  }
  timerSeconds = initialSeconds;
  startBtn.disabled = false;
  pauseBtn.disabled = true;
  stopBtn.disabled = true;
  updateTimerDisplay();
  statusEl.textContent = 'ğŸ”„ ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚';
  
  // ãƒ¡ãƒ‡ã‚£ã‚¢åœæ­¢
  if (isCompleteSound) {
    if (isVideo) {
      videoPlayer.pause();
      videoPlayer.currentTime = 0;
      videoPanel.style.display = 'none';
    } else {
      completeSound.pause();
      completeSound.currentTime = 0;
    }
    isCompleteSound = false;
  }
}

// å‹•ç”»ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
videoCloseBtn.addEventListener('click', () => {
  videoPlayer.pause();
  videoPanel.style.display = 'none';
  if (isCompleteSound) {
    isCompleteSound = false;
  }
});

startBtn.addEventListener('click', startTimer);
pauseBtn.addEventListener('click', pauseTimer);
stopBtn.addEventListener('click', () => {
  if (!facePresent || (performance.now() - facePresentSince) < 500) {
    alert('é¡”ãŒæ¤œå‡ºã•ã‚Œã¦ã„ãªã„ãŸã‚åœæ­¢ã§ãã¾ã›ã‚“ã€‚');
    return;
  }
  stopTimer();
});
resetBtn.addEventListener('click', resetTimer);

// Notification.permission ãŒ 'default' ã®å ´åˆã®ã¿ã€æ¨©é™ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
if (Notification.permission === 'default') {
  Notification.requestPermission();
}

updateTimerDisplay();

// ãƒ“ãƒ‡ã‚ªè¦ç´ ãŒã‚ã‚‹å ´åˆã®ã¿ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•
if (video) {
  startCamera();
}

// ãƒ‡ãƒã‚¤ã‚¹é¸æŠã®è‡ªå‹•å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
deviceSelect.addEventListener('change', async () => {
  const selectedDeviceId = deviceSelect.value;
  
  const promises = [];
  
  if (completeSound.setSinkId) {
    promises.push(completeSound.setSinkId(selectedDeviceId));
  }
  
  if (videoPlayer.setSinkId) {
    promises.push(videoPlayer.setSinkId(selectedDeviceId));
  }
  
  if (promises.length > 0) {
    try {
      await Promise.all(promises);
      console.log('ãƒ‡ãƒã‚¤ã‚¹å¤‰æ›´æˆåŠŸ:', selectedDeviceId);
    } catch (err) {
      console.error('ãƒ‡ãƒã‚¤ã‚¹å¤‰æ›´ã‚¨ãƒ©ãƒ¼:', err);
    }
  }
});
</script>
</body>
</html>
